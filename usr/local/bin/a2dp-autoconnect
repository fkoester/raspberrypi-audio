#!/bin/bash
# Source: https://gist.github.com/oleq/24e09112b07464acbda1
# The original script: http://blog.mrverrall.co.uk/2013/01/raspberry-pi-a2dp-bluetooth-audio.html.

# Find the right sink with `pactl list sinks short`.
PA_SINK=$(pactl list sinks short | head -n1 | awk '{print $2}')
BT_MAC=$(echo "$NAME" | sed 's/:/_/g' | sed 's/\"//g')

function log {
	echo "[$(date)]: $*" >> /var/log/a2dp-autoconnect
}

function checkSource {
	# Get the current sources
	local _sources=$(pactl list sources short)

	# Check if any sources are currently running and that our new device is valid.
	if [[ "$_sources" =~ RUNNING ]]; then
		log "Source is already RUNNING. Available sources:"
		log "$_sources"
		return
	fi

	if [[ ! "$_sources" =~ "$1" ]] ; then
		log "Unrecognized source. Available sources:"
		log "\n$_sources"
		return
	fi

	log "Validated new source: $1."
	echo "$1"
}

function connect {
	log "Connecting $1."

	# Connect source to sink
	pactl load-module module-loopback source="$1" sink="$PA_SINK" latency_msec=100
}

log "Change for device $BT_MAC detected, running $ACTION."

if [ "$ACTION" = "add" ]
then
	incoming=bluez_source."$BT_MAC"
	if [ ! -z $(checkSource "$incoming") ] ; then
		connect "$incoming"
	fi
fi
